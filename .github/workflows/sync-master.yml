name: Sync Upstream Master

on:
  schedule:
    - cron: '0 8 * * *' # Runs every day at 8:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: Sync with upstream master
    runs-on: ubuntu-24.04
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch || 'master' }}
      UPSTREAM_REPO: https://github.com/obsproject/obs-studio.git
      PUSH_TOKEN: ${{ secrets.NAD_AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.PUSH_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "NAD Sync Bot"
          git config user.email "noreply@github.com"
          git remote set-url origin "https://x-access-token:${{ env.PUSH_TOKEN }}@github.com/${{ github.repository }}.git"

      - name: Merge Upstream Master
        run: |
          set -euo pipefail

          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream ${{ env.UPSTREAM_REPO }}
          else
            git remote add upstream ${{ env.UPSTREAM_REPO }}
          fi

          git fetch upstream --prune master
          git fetch origin --prune ${{ env.DEFAULT_BRANCH }}

          git checkout "${{ env.DEFAULT_BRANCH }}"
          git reset --hard "origin/${{ env.DEFAULT_BRANCH }}"

          echo "Merging upstream/master with protected files..."

          # Configure merge strategy to prefer our version for specific files
          git config merge.ours.driver true

          # Create temporary merge attributes in .git/info/attributes
          cat > .git/info/attributes << EOF
          .github/workflows/ merge=ours
          build-aux/steam/scripts_macos/launch.sh merge=ours
          EOF

          # Check if build-aux/com.obsproject.Studio.json exists before merge
          FLATPAK_MANIFEST="build-aux/com.obsproject.Studio.json"
          MANIFEST_CHECK_NEEDED=false
          CURRENT_MANIFEST_HASH=""

          if [[ -f "$FLATPAK_MANIFEST" ]]; then
            MANIFEST_CHECK_NEEDED=true
            CURRENT_MANIFEST_HASH=$(git hash-object "$FLATPAK_MANIFEST")
            echo "Detected $FLATPAK_MANIFEST, current hash: $CURRENT_MANIFEST_HASH"
            echo "Will check for changes after merge..."
          fi

          # Check if CMakePresets.json exists before merge
          CMAKE_PRESETS="CMakePresets.json"
          PRESETS_CHECK_NEEDED=false
          CURRENT_PRESETS_HASH=""

          if [[ -f "$CMAKE_PRESETS" ]]; then
            PRESETS_CHECK_NEEDED=true
            CURRENT_PRESETS_HASH=$(git hash-object "$CMAKE_PRESETS")
            echo "Detected $CMAKE_PRESETS, current hash: $CURRENT_PRESETS_HASH"
            echo "Will check for changes after merge..."
          fi

          # Check if package.applescript exists before merge
          PACKAGE_SCRIPT="cmake/macos/resources/package.applescript"
          SCRIPT_CHECK_NEEDED=false
          CURRENT_SCRIPT_HASH=""

          if [[ -f "$PACKAGE_SCRIPT" ]]; then
            SCRIPT_CHECK_NEEDED=true
            CURRENT_SCRIPT_HASH=$(git hash-object "$PACKAGE_SCRIPT")
            echo "Detected $PACKAGE_SCRIPT, current hash: $CURRENT_SCRIPT_HASH"
            echo "Will check for changes after merge..."
          fi

          # Define scripts to check and capture their current hashes before merge
          declare -A SCRIPT_HASHES_CURRENT
          SYNC_SCRIPTS=(
            "version-sync.py"
            ".build.zsh"
            ".package.zsh"
            "Build-Windows.ps1"
            "Package-Windows.ps1"
          )

          SCRIPTS_DIR=".github/scripts"
          GITHUB_SCRIPTS_CHECK_NEEDED=false

          # Capture current hashes for all scripts before merge
          for script in "${SYNC_SCRIPTS[@]}"; do
            script_path="$SCRIPTS_DIR/$script"
            if [[ -f "$script_path" ]]; then
              GITHUB_SCRIPTS_CHECK_NEEDED=true
              SCRIPT_HASHES_CURRENT["$script"]=$(git hash-object "$script_path")
              echo "Detected $script_path, current hash: ${SCRIPT_HASHES_CURRENT[$script]}"
            fi
          done

          if [[ "$GITHUB_SCRIPTS_CHECK_NEEDED" == "true" ]]; then
            echo "Will check for changes after merge..."
          fi

          # Execute merge
          git merge --no-ff --no-edit "upstream/master" || {
            echo "Merge conflict detected, resolving with protected files..."
            git checkout --ours .github/workflows/ 2>/dev/null || true
            git checkout --ours build-aux/steam/scripts_macos/launch.sh 2>/dev/null || true
            git add .
            git commit --no-edit || true
          }

          # Check if manifest file was modified
          if [[ "$MANIFEST_CHECK_NEEDED" == "true" ]]; then
            NEW_MANIFEST_HASH=$(git hash-object "$FLATPAK_MANIFEST")
            if [[ "$CURRENT_MANIFEST_HASH" != "$NEW_MANIFEST_HASH" ]]; then
              echo "❗ WARNING: $FLATPAK_MANIFEST has been modified by upstream"
              echo "Current hash: $CURRENT_MANIFEST_HASH"
              echo "New hash: $NEW_MANIFEST_HASH"
              echo ""
              echo "The following customizations may need review:"
              echo "  - AJA support configuration (-DENABLE_AJA)"
              echo "  - DeckLink support configuration (-DENABLE_DECKLINK)"
              echo "  - System permissions and security settings"
              echo ""
              echo "Please review the changes manually before proceeding."
              exit 1
            else
              echo "✓ $FLATPAK_MANIFEST unchanged, continuing..."
            fi
          fi

          # Check if package.applescript was modified
          if [[ "$SCRIPT_CHECK_NEEDED" == "true" ]]; then
            NEW_SCRIPT_HASH=$(git hash-object "$PACKAGE_SCRIPT")
            if [[ "$CURRENT_SCRIPT_HASH" != "$NEW_SCRIPT_HASH" ]]; then
              echo "❗ WARNING: $PACKAGE_SCRIPT has been modified by upstream"
              echo "Current hash: $CURRENT_SCRIPT_HASH"
              echo "New hash: $NEW_SCRIPT_HASH"
              echo ""
              echo "Please verify the following NAD customizations are preserved:"
              echo "  - APP_NAME_PLACEHOLDER variable (not hardcoded 'OBS.app')"
              echo ""
              echo "Please review the changes manually before proceeding."
              exit 1
            else
              echo "✓ $PACKAGE_SCRIPT unchanged, continuing..."
            fi
          fi

          # Check if .github/scripts/ files were modified
          if [[ "$GITHUB_SCRIPTS_CHECK_NEEDED" == "true" ]]; then
            SCRIPT_MODIFIED=false
            for script in "${SYNC_SCRIPTS[@]}"; do
              script_path="$SCRIPTS_DIR/$script"
              if [[ -f "$script_path" ]]; then
                NEW_HASH=$(git hash-object "$script_path")
                CURRENT_HASH_VALUE="${SCRIPT_HASHES_CURRENT[$script]}"
                if [[ "$CURRENT_HASH_VALUE" != "$NEW_HASH" ]]; then
                  echo "❗ WARNING: $script_path has been modified by upstream"
                  echo "Current hash: $CURRENT_HASH_VALUE"
                  echo "New hash: $NEW_HASH"
                  SCRIPT_MODIFIED=true
                fi
              fi
            done

            if [[ "$SCRIPT_MODIFIED" == "true" ]]; then
              echo ""
              echo "The following NAD-specific scripts may need review:"
              echo "  - version-sync.py: NAD version management tool"
              echo "  - Build scripts: NAD custom build configurations"
              echo "  - Package scripts: NAD packaging customizations"
              echo ""
              echo "Please review all script changes manually before proceeding."
              exit 1
            else
              echo "✓ All .github/scripts/ files unchanged, continuing..."
            fi
          fi

          # Check if CMakePresets.json was modified
          if [[ "$PRESETS_CHECK_NEEDED" == "true" ]]; then
            NEW_PRESETS_HASH=$(git hash-object "$CMAKE_PRESETS")
            if [[ "$CURRENT_PRESETS_HASH" != "$NEW_PRESETS_HASH" ]]; then
              echo "❗ WARNING: $CMAKE_PRESETS has been modified by upstream"
              echo "Current hash: $CURRENT_PRESETS_HASH"
              echo "New hash: $NEW_PRESETS_HASH"
              echo ""
              echo "Please verify the following NAD customizations are preserved:"
              echo "  - APP_DESTINATION with 'OBS Studio-no-aja.app'"
              echo "  - OBS_BUNDLE with 'com.yourcompany.obs-no-aja'"
              echo "  - VLC_BUNDLE with 'org.videolan.vlc-no-aja'"
              echo "  - ENABLE_AJA disabled (set to OFF)"
              echo ""
              exit 1
            else
              echo "✓ $CMAKE_PRESETS unchanged, continuing..."
            fi
          fi

      - name: Push Changes
        run: |
          if git diff --quiet HEAD "origin/${{ env.DEFAULT_BRANCH }}"; then
            echo "No changes to push."
          else
            echo "Pushing changes to origin/${{ env.DEFAULT_BRANCH }}..."
            git push origin "${{ env.DEFAULT_BRANCH }}"
          fi
