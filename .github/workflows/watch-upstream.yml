name: Watch Upstream Releases

on:
  schedule:
    # æ¯3å¤©æ£€æŸ¥ä¸€æ¬¡ä¸Šæ¸¸å‘å¸ƒ
    - cron: '0 0 */3 * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼ºåˆ¶æ£€æŸ¥ï¼ˆå³ä½¿æ ‡ç­¾å·²å­˜åœ¨ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: write

jobs:
  check-upstream:
    name: Check Upstream Releases
    runs-on: ubuntu-24.04
    steps:
      - name: Check Latest Upstream Release
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_CHECK: ${{ github.event.inputs.force_check || 'false' }}
        run: |
          set -euo pipefail
          
          echo "Checking for new releases from obsproject/obs-studio..."
          
          # èŽ·å–ä¸Šæ¸¸æœ€æ–°å‘å¸ƒï¼ˆåŒ…æ‹¬ pre-releaseï¼‰
          upstream_release=$(gh api /repos/obsproject/obs-studio/releases --jq '.[0]')

          if [[ -z "${upstream_release}" || "${upstream_release}" == "null" ]]; then
            echo "::error::Failed to fetch latest release from upstream or no releases found."
            exit 1
          fi
          
          upstream_tag=$(echo "$upstream_release" | jq -r '.tag_name' | sed 's/^v//')
          is_prerelease=$(echo "$upstream_release" | jq -r '.prerelease')
          release_name=$(echo "$upstream_release" | jq -r '.name')
          
          echo "Found upstream release: ${upstream_tag} (prerelease: ${is_prerelease})"
          echo "Release name: ${release_name}"
          
          # Check if the corresponding -no-aja tag already exists in our repo
          nad_tag="${upstream_tag}-no-aja"
          
          if [[ "${FORCE_CHECK}" == "true" ]]; then
            echo "Force check enabled, will trigger sync."
            should_sync=true
          elif gh api "/repos/${{ github.repository }}/git/ref/tags/${nad_tag}" > /dev/null 2>&1; then
            echo "Tag ${nad_tag} already exists, skipping sync."
            should_sync=false
          else
            echo "New upstream release detected: ${upstream_tag}. Triggering sync."
            should_sync=true
          fi
          
          {
            echo "should_sync=${should_sync}"
            echo "upstream_version=${upstream_tag}"
            echo "nad_tag=${nad_tag}"
            echo "is_prerelease=${is_prerelease}"
            echo "release_name=${release_name}"
          } >> "$GITHUB_OUTPUT"

      - name: Trigger Sync & Build Workflow
        if: steps.check.outputs.should_sync == 'true'
        env:
          GH_TOKEN: ${{ secrets.NAD_AUTOMATION_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          upstream_version="${{ steps.check.outputs.upstream_version }}"
          repository="${{ github.repository }}"

          echo "Triggering 'Sync and Build' workflow for version ${upstream_version}"

          gh workflow run sync-and-build.yml -f "upstream_version=${upstream_version}" --repo "${repository}"

          echo "âœ… 'Sync and Build' workflow triggered successfully for ${upstream_version}"
          echo "Expected NAD tag: ${{ steps.check.outputs.nad_tag }}"

      - name: Summary
        if: always()
        run: |
          set -euo pipefail

          upstream_version="${{ steps.check.outputs.upstream_version }}"
          nad_tag="${{ steps.check.outputs.nad_tag }}"
          is_prerelease="${{ steps.check.outputs.is_prerelease }}"
          should_sync="${{ steps.check.outputs.should_sync }}"
          repository="${{ github.repository }}"

          {
            echo "### Upstream Release Check Summary ðŸ“Š"
            echo ""
            echo "- **Upstream Version**: ${upstream_version}"
            echo "- **NAD Tag**: ${nad_tag}"
            echo "- **Is Pre-release**: ${is_prerelease}"
            echo "- **Sync Triggered**: ${should_sync}"
            echo ""

            if [[ "${should_sync}" == "true" ]]; then
              echo "ðŸš€ Sync workflow has been triggered. Check the [Actions](https://github.com/${repository}/actions) page."
            else
              echo "â„¹ï¸ No sync needed - tag already exists or no new release found."
            fi
          } >> "${GITHUB_STEP_SUMMARY}"
