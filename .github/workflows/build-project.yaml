name: Build Project
on:
  workflow_call:
jobs:
  check-event:
    name: Event Data
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    outputs:
      package: ${{ steps.setup.outputs.package }}
      codesign: ${{ steps.setup.outputs.codesign }}
      notarize: ${{ steps.setup.outputs.notarize }}
      config: ${{ steps.setup.outputs.config }}
      commitHash: ${{ steps.setup.outputs.commitHash }}
      isUpstreamRelease: ${{ steps.setup.outputs.isUpstreamRelease }}
      upstreamVersion: ${{ steps.setup.outputs.upstreamVersion }}
      nadVersion: ${{ steps.setup.outputs.nadVersion }}
      versionPayload: ${{ steps.setup.outputs.versionPayload }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Event Data
        id: setup
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if [[ "${RUNNER_DEBUG:-}" ]]; then set -x; fi

          emit_output() {
            printf '%s=%s\n' "$1" "$2" >> "$GITHUB_OUTPUT"
          }

          set_flag() {
            local key=$1 value=$2
            for idx in "${!config_data[@]}"; do
              if [[ "${config_data[idx]}" == "${key}:"* ]]; then
                config_data[idx]="${key}:${value}"
                return
              fi
            done
            config_data+=("${key}:${value}")
          }

          mapping_file="${GITHUB_WORKSPACE}/version-mapping.json"
          default_nad_version="0.0.0-no-aja"
          if [[ -r "${mapping_file}" ]]; then
            extracted=$(jq -re '
              [
                .last_sync.nad_version,
                (.version_mappings // {} | to_entries | sort_by(.key) | reverse | (.[0].value // empty))
              ]
              | map(select(. != null and . != ""))
              | (.[0] // empty)
            ' "${mapping_file}" 2>/dev/null || true)
            if [[ -n "${extracted}" ]]; then
              default_nad_version="${extracted}"
            fi
          fi
          default_upstream_version="${default_nad_version%-no-aja}"

          is_upstream_release=false
          upstream_version=""
          nad_version=""

          config_data=('codesign:false' 'notarize:false' 'package:false' 'config:RelWithDebInfo')

          case "${GITHUB_EVENT_NAME}" in
            pull_request)
              if gh pr view "${{ github.event.number }}" --json labels \
                | jq -e -r '.labels[] | select(.name == "Seeking Testers")' > /dev/null; then
                set_flag codesign true
                set_flag package true
              fi
              ;;
            push)
              set_flag codesign true
              set_flag package true

              latest_author=$(git log -1 --pretty='%an <%ae>')
              latest_message=$(git log -1 --pretty='%B')
              if [[ "${latest_author}" == OBS\ NAD\ Sync\ Bot* ]] && grep -q "Upstream version:" <<< "${latest_message}"; then
                upstream_version=$(grep -Eo 'Upstream version:[[:space:]]*[^[:space:]]+' <<< "${latest_message}" | sed -E 's/Upstream version:[[:space:]]*//' | head -1)
                if [[ -n "${upstream_version}" ]]; then
                  is_upstream_release=true
                  nad_version="${upstream_version}-no-aja"
                  echo "Detected upstream sync commit for ${upstream_version}"
                fi
              elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
                tag_name="${GITHUB_REF_NAME}"
                base_tag="${tag_name#v}"
                suffix=""
                if [[ "${base_tag}" == *"-no-aja" ]]; then
                  suffix="-no-aja"
                  base_tag="${base_tag%-no-aja}"
                fi
                if [[ "${base_tag}" =~ ^[0-9]+(\.[0-9]+){1,2}(-(rc|beta).+)?$ ]]; then
                  is_upstream_release=true
                  upstream_version="${base_tag}"
                  if [[ -n "${suffix}" ]]; then
                    nad_version="${base_tag}${suffix}"
                  else
                    nad_version="${base_tag}-no-aja"
                  fi
                  set_flag notarize true
                  echo "Detected tag release: ${nad_version}"
                fi
              fi
              ;;
            workflow_dispatch)
              manual_version="${{ github.event.inputs.version || '' }}"
              set_flag codesign true
              if [[ -n "${manual_version}" ]]; then
                upstream_version="${manual_version#v}"
                nad_version="${upstream_version}-no-aja"
                set_flag package true
                echo "Manual sync with version: ${nad_version}"
              fi
              ;;
            repository_dispatch)
              set_flag codesign true
              set_flag package true
              payload_version="${{ github.event.client_payload.version || '' }}"
              payload_nad="${{ github.event.client_payload.nad_version || '' }}"
              payload_release="${{ github.event.client_payload.is_upstream_release || 'false' }}"
              if [[ -n "${payload_version}" ]]; then
                upstream_version="${payload_version#v}"
              fi
              if [[ -n "${payload_nad}" ]]; then
                nad_version="${payload_nad}"
              elif [[ -n "${upstream_version}" ]]; then
                nad_version="${upstream_version}-no-aja"
              fi
              if [[ "${payload_release}" == "true" ]]; then
                is_upstream_release=true
                set_flag notarize true
              fi
              ;;
            schedule)
              set_flag codesign true
              set_flag package true
              ;;
            *)
              ;;
          esac

          if [[ -z "${nad_version}" ]]; then
            nad_version="${default_nad_version}"
          fi
          if [[ -z "${upstream_version}" ]]; then
            upstream_version="${default_upstream_version}"
          fi

          emit_output isUpstreamRelease "${is_upstream_release}"
          emit_output upstreamVersion "${upstream_version}"
          emit_output nadVersion "${nad_version}"

          for config in "${config_data[@]}"; do
            IFS=':' read -r key value <<< "${config}"
            emit_output "${key}" "${value}"
          done
          emit_output commitHash "${GITHUB_SHA:0:9}"

          emit_output versionPayload "$(jq -nc --arg upstream "${upstream_version}" --arg nad "${nad_version}" --arg release "${is_upstream_release}" '{upstreamVersion:$upstream,nadVersion:$nad,isUpstreamRelease:($release=="true")}')"

  macos-build:
    name: macOS
    runs-on: macos-15
    needs: check-event
    # NAD: ÂßãÁªàÊûÑÂª∫ macOSÔºåÂåÖÊã¨Ê†áÁ≠æÊé®ÈÄÅÊó∂
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.4.app/Contents/Developer
      MACOSX_DEPLOYMENT_TARGET: 13.0
      CMAKE_OSX_DEPLOYMENT_TARGET: 13.0
    strategy:
      fail-fast: false
      matrix:
        target: [arm64, x86_64]
    defaults:
      run:
        shell: zsh --no-rcs --errexit --pipefail {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set Up Environment
        id: setup
        run: |
          : Set Up Environment
          if (( ${+RUNNER_DEBUG} )) setopt XTRACE

          print '::group::Select Xcode (no sudo)'
          echo "DEVELOPER_DIR=/Applications/Xcode_16.4.app/Contents/Developer" >> $GITHUB_ENV
          print '::endgroup::'

          print '::group::Clean Homebrew Environment'
          local -a unwanted_formulas=()
          local -a remove_formulas=()
          for formula (${unwanted_formulas}) {
            if [[ -d ${HOMEBREW_PREFIX}/Cellar/${formula} ]] remove_formulas+=(${formula})
          }

          if (( #remove_formulas )) brew uninstall --ignore-dependencies ${remove_formulas}
          print '::endgroup::'

          local -A arch_names=(x86_64 intel arm64 apple)
          print "cpuName=${arch_names[${{ matrix.target }}]}" >> $GITHUB_OUTPUT

      - name: Clean build artifacts
        run: |
          rm -rf build_macos
          find . -name CMakeCache.txt -delete

      - name: Debug deployment target env
        run: |
          env | sort | egrep 'MACOSX|OSX_DEPLOYMENT|CMAKE_OSX' || true

      - uses: actions/cache/restore@v4
        id: ccache-cache
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-ccache-${{ matrix.target }}-${{ needs.check-event.outputs.config }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ matrix.target }}-

      # NAD: Ë∑≥Ëøá‰ª£Á†ÅÁ≠æÂêçËÆæÁΩÆÔºàÊó†ËØÅ‰π¶Ôºâ
      # - name: Set Up Code Signing üîë
      #   uses: ./.github/actions/setup-macos-codesigning
      #   if: false
      #   id: codesign

      - name: Build OBS Studio
        uses: ./.github/actions/build-obs
        env:
          TWITCH_CLIENTID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_HASH: ${{ secrets.TWITCH_HASH }}
          RESTREAM_CLIENTID: ${{ secrets.RESTREAM_CLIENTID }}
          RESTREAM_HASH: ${{ secrets.RESTREAM_HASH }}
          YOUTUBE_CLIENTID: ${{ secrets.YOUTUBE_CLIENTID }}
          YOUTUBE_CLIENTID_HASH: ${{ secrets.YOUTUBE_CLIENTID_HASH }}
          YOUTUBE_SECRET: ${{ secrets.YOUTUBE_SECRET }}
          YOUTUBE_SECRET_HASH: ${{ secrets.YOUTUBE_SECRET_HASH }}
        with:
          target: ${{ matrix.target }}
          config: ${{ needs.check-event.outputs.config }}
          # NAD: Áõ¥Êé•Á¶ÅÁî®Á≠æÂêçÔºàÊó†ËØÅ‰π¶Ôºâ
          codesign: false
          codesignIdent: '-'
          codesignTeam: ''
          provisioningProfileUUID: ''
          version: ${{ needs.check-event.outputs.nadVersion }}

      - name: Package OBS Studio
        uses: ./.github/actions/package-obs
        with:
          target: ${{ matrix.target }}
          config: ${{ needs.check-event.outputs.config }}
          package: ${{ fromJSON(needs.check-event.outputs.package) }}
          # NAD: Áõ¥Êé•Á¶ÅÁî®Á≠æÂêçÂíåÂÖ¨ËØÅÔºàÊó†ËØÅ‰π¶Ôºâ
          codesign: false
          codesignIdent: '-'
          notarize: false
          codesignUser: ''
          codesignPass: ''

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obs-studio-macos-${{ matrix.target }}-${{ needs.check-event.outputs.commitHash }}
          path: ${{ github.workspace }}/build_macos/obs-studio-*-macos-${{ steps.setup.outputs.cpuName }}.*

      - name: Upload Debug Symbol Artifacts
        uses: actions/upload-artifact@v4
        if: ${{ needs.check-event.outputs.config == 'Release' }}
        with:
          name: obs-studio-macos-${{ matrix.target }}-${{ needs.check-event.outputs.commitHash }}-dSYMs
          path: ${{ github.workspace }}/build_macos/obs-studio-*-macos-${{ steps.setup.outputs.cpuName }}-dSYMs.tar.xz

      - uses: actions/cache/save@v4
        if: github.event_name != 'pull_request' && steps.ccache-cache.outputs.cache-hit != 'true'
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-ccache-${{ matrix.target }}-${{ needs.check-event.outputs.config }}
